Ejecutar comando en consola SSH

@echo off
setlocal enabledelayedexpansion

 Explicaci√≥n de mejoras
- Variables configurables: usuario, host, ruta del repo y rama (main).
- Validaci√≥n de errores: si falla la conexi√≥n SSH o el git pull, muestra mensaje ‚ùå y no contin√∫a.
- Mensajes claros: indica inicio, √©xito o error.
- Uso de git fetch + reset --hard: asegura que el repo en la VM quede id√©ntico al remoto, evitando conflictos.
- Recarga autom√°tica de Nginx: al final del deploy


‚ñ∂Ô∏è C√≥mo usarlo
- Guarda el archivo como deploy.bat.
- Haz doble clic para ejecutarlo.
- Ver√°s mensajes en consola indicando si el deploy fue exitoso o si hubo errores.

‚úÖ Con este .bat tienes un flujo de deploy robusto y seguro.
¬øQuieres que lo prepare tambi√©n para que se ejecute autom√°ticamente cada cierto tiempo con el Programador de tareas de Windows, sin necesidad de hacer doble clic?


üñ•Ô∏è Configurar ejecuci√≥n autom√°tica del deploy.bat
1. Guarda tu archivo .bat
- Aseg√∫rate de tener tu deploy.bat robusto en una carpeta fija (ej. C:\Scripts\deploy.bat).
- Verifica que al ejecutarlo manualmente funciona bien.

2. Abrir el Programador de tareas
- Presiona Win + R, escribe taskschd.msc y pulsa Enter.
- Se abrir√° el Programador de tareas.

3. Crear una nueva tarea
- En el panel derecho, selecciona Crear tarea.
- Ponle un nombre: Deploy Nginx VM.
- Marca la opci√≥n Ejecutar con los privilegios m√°s altos (para que pueda usar SSH).

4. Configurar el disparador (Trigger)
- Ve a la pesta√±a Desencadenadores ‚Üí Nuevo.
- Elige cu√°ndo quieres que se ejecute:
- Diariamente a una hora fija.
- Cada hora (elige ‚ÄúRepetir cada 1 hora durante 1 d√≠a‚Äù).
- O al iniciar sesi√≥n si quieres que corra al entrar en Windows.

5. Configurar la acci√≥n
- Ve a la pesta√±a Acciones ‚Üí Nuevo.
- Acci√≥n: Iniciar un programa.
- Programa/script: selecciona tu archivo deploy.bat.
- Ejemplo: C:\Scripts\deploy.bat.

6. Opciones avanzadas
- En la pesta√±a Condiciones, desmarca ‚ÄúIniciar la tarea solo si el equipo est√° con corriente alterna‚Äù si quieres que corra siempre.
- En la pesta√±a Configuraci√≥n, marca ‚ÄúDetener la tarea si se ejecuta m√°s de X horas‚Äù (ej. 1 hora).

7. Probar la tarea
- Haz clic derecho sobre tu tarea ‚Üí Ejecutar.
- Verifica que se conecta a tu VM, hace git pull y recarga Nginx.

‚úÖ Resultado
Con esto tu .bat se ejecutar√° autom√°ticamente seg√∫n la programaci√≥n que definas.
- Si lo pones cada hora ‚Üí tu web se actualizar√° sola con los cambios de GitHub.
- Si lo pones al iniciar sesi√≥n ‚Üí siempre tendr√°s el deploy al encender tu PC.





echo ============================================
echo   Deploy manual a Nginx (VM Remota)
echo ============================================
cd /var/www/site
git pull origin main
sudo systemctl reload nginx


echo ============================================
echo   Deploy autom√°tico a Nginx (VM Remota)
echo ============================================

REM Configuraci√≥n de conexi√≥n
set VM_USER=contrerasaurelio67
set VM_HOST=atelier-content-engine-v2
set VM_PATH=/var/www/site
set BRANCH=main

echo Conectando a %VM_USER%@%VM_HOST% ...
echo.

REM Ejecutar comandos en la VM v√≠a SSH
ssh %VM_USER%@%VM_HOST% "cd %VM_PATH% && git fetch origin %BRANCH% && git reset --hard origin/%BRANCH% && sudo systemctl reload nginx"

IF %ERRORLEVEL% NEQ 0 (
    echo --------------------------------------------
    echo ‚ùå ERROR: El deploy ha fallado.
    echo Revisa tu conexi√≥n SSH o permisos en la VM.
    echo --------------------------------------------
    pause
    exit /b %ERRORLEVEL%
) ELSE (
    echo --------------------------------------------
    echo ‚úÖ Deploy completado correctamente.
    echo Se actualiz√≥ la rama %BRANCH% y Nginx fue recargado.
    echo --------------------------------------------
)

pause
endlocal